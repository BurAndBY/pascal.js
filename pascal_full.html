<html>
<head>
  <title>pascal.js</title>
</head>
<body>
<h2>pascal.js - Pascal Compiler in JavaScript</h2>
<p>
  Pascal.js is a Pascal compiler (Turbo Pascal 1.0-ish) implemented in
  JavaScript that outputs <a href="http://llvm.org">LLVM</a> IR. From
  the command line (using Node.js), LLVM is used as a backend to
  generate native code. This online version uses <a href="http://github.com/azakai/llvm.js">LLVM.js</a>
  to compile the LLVM IR to JavaScript. 
</p>
<p>
  <code><b><a href="https://github.com/kanaka/pascal.js">github.com/kanaka/pascal.js</a></b></code>
</p>
<hr>
Pascal Source:<br>
<textarea id="the_source" cols=90 rows=13 style="background-color: #eeeeff; border: 1px solid black; margin-top: 0.3em; margin-bottom: 0.3em">
program HelloWorld;
begin
  WriteLn('Hello World!');
end.
</textarea>
<br>
<input value="Parse" type="button" onclick="doParse()">
<br>
Abstract Syntax Tree:<br>
<textarea id="the_ast" cols=90 rows=5 style="border: 1px solid black; margin-bottom: 0.6em">
</textarea>
<br>
<input value="Compile to IR" type="button" onclick="doIR()">
<br>
LLVM IR:<br>
<textarea id="the_ir" cols=90 rows=5 style="border: 1px solid black; margin-bottom: 0.6em">
</textarea>
<br>
<input value="Optimize and compile IR to JS" type="button" onclick="doCompile1()">
<input value="Compile IR to JS" type="button" onclick="doCompile2()">
<br>
Compiled JavaScript:<br>
<textarea id="the_js" cols=90 rows=5 style="border: 1px solid black; margin-bottom: 0.6em">
</textarea>
<br>
<input value="Execute/evaluate JS" type="button" onclick="doExecute()">
<br>
Execution Output:<br>
<textarea id="the_output" cols=90 rows=5 style="border: 1px solid black; margin-bottom: 0.6em">
</textarea>
<br>

<script src="parse.js"></script>
<script src="ieee754.js"></script>
<script src="ir.js"></script>
<script>
  // emscripten workarounds
  arguments = [];

  var Module = {};

  // Keep LLVM.js from triggering browser print dialog
  print = function () { };

  // Monkey patch XMLHttpRequest open to be relative to XHR_PREFIX
  (function(xhr) {
    var orig_open = xhr.open;
    xhr.open = function(method, url) {
        var rest = Array.prototype.slice.apply(arguments).slice(2);
        if (window.XHR_PREFIX && url.substr(0,4).toLowerCase() !== "http") {
          url = XHR_PREFIX + url;
        }
        return orig_open.apply(this, [method, url].concat(rest));
    };
  })(XMLHttpRequest.prototype);

  var XHR_PREFIX = "llvm.js/";

</script>
<script src="llvm.js/llvm-as.js"></script>
<script src="llvm.js/llvm-dis.js"></script>
<script src="llvm.js/compiler.js">
</script>
<script>
  function doParse() {
    var source = document.getElementById('the_source').value,
        outElem = document.getElementById('the_ast'),
        parser = new parse.Parser(),
        ast = null;
    try {
      ast = parser.parse(source);
      outElem.style.backgroundColor = '#eeffee';
      outElem.value = JSON.stringify(ast,null,4);
    } catch (e) {
      outElem.style.backgroundColor = '#ffe0e0';
      outElem.value = 'Error in parsing: ' + e; // error message
      return;
    }
  }

  function doIR() {
    var json_ast = document.getElementById('the_ast').value,
        ast = JSON.parse(json_ast),
        outElem = document.getElementById('the_ir'),
        IR_API = new IR(),
        ir = null;
    XHR_PREFIX = "";
    try {
      ir = IR_API.normalizeIR(IR_API.toIR(ast));
      outElem.style.backgroundColor = '#eeffee';
      outElem.value = ir;
    } catch(e) {
      outElem.style.backgroundColor = '#ffe0e0';
      outElem.value = 'Error compiling to IR: ' + e; // error message
    }
  }

  function doCompile1() {
    XHR_PREFIX = "llvm.js/";
    var ir = document.getElementById('the_ir').value,
        outElem = document.getElementById('the_js'),
        new_ir = '', js = '';

    try {
      new_ir = llvmDis(llvmAs(ir));
    } catch (e) {
      outElem.style.backgroundColor = '#ffe0e0';
      outElem.value = 'Error in compilation: ' + e; // error message
      return;
    }

    print = function(x) { js += x; };
    compile(new_ir);
    if (js && js[0] != 'E') {
      outElem.style.backgroundColor = '#eeffee';
      outElem.value = js;
    } else {
      outElem.style.backgroundColor = '#ffe0e0';
      outElem.value = js; // error message
    }
  }

  function doCompile2() {
    XHR_PREFIX = "llvm.js/";
    var ir = document.getElementById('the_ir').value,
        outElem = document.getElementById('the_js'),
        js = '';

    print = function(x) { js += x; };
    compile(ir);
    if (js && js[0] != 'E') {
      outElem.style.backgroundColor = '#eeffee';
      outElem.value = js;
    } else {
      outElem.style.backgroundColor = '#ffe0e0';
      outElem.value = js; // error message
    }
  }

  function doExecute() {
    XHR_PREFIX = "";
    var js = document.getElementById('the_js').value,
        outElem = document.getElementById('the_output');
    outElem.value = '';
    Module.print = print = function(x) { outElem.value += x + '\n'; };
    try {
      eval(js);
      outElem.style.backgroundColor = '#eeffee';
    } catch(e) {
      outElem.style.backgroundColor = '#ffe0e0';
      outElem.value = 'Error in execution: ' + e; // error message
    }
  }
</script>
</body>
</html>

